{% extends "base.html" %}
{% load static %}
{% block title %}PTO{% endblock title %}
{% block page-title %}Leave Details {% endblock page-title %}



{% block style %}

    .sortable:hover {
        cursor: pointer;
    }
    .sort-arrow {
        margin-left: 5px;
        font-size: 0.8rem;
    }

    .small-btn {
        padding: 2px 8px; /* Adjust padding to reduce button size */
        font-size: 12px; /* Adjust font size */
        height: 35px; /* Set a specific height */
        width: auto; /* Adjust width as needed */
        line-height: 1; /* Adjust line height for better alignment */
    }  
   
    /* Custom styles for smaller pagination buttons */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 5px 10px; /* Adjust padding for smaller buttons */
        font-size: 12px; /* Adjust font size */
        margin: 0 2px; /* Adjust margin between buttons */
    }


    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #007bff; /* Change background color for the current page */
        color: white; /* Change text color for the current page */
    }


    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #0056b3; /* Change background color on hover */
        color: white; /* Change text color on hover */
    }
   
    .column-head th {
        background-color: #9e6de0;
        color: white !important;
    }
    .table-product {
        width: 100% !important;
        table-layout: auto; /* Allow columns to size dynamically */
        white-space: nowrap; /* Prevent text from wrapping */
    }
        .hover-white:hover {
            color: white !important;
        }


{% endblock %}

{% block content %}
<main id="main" class="main">
    <div class="card card-default m-2">


    <div class="card">
        <div class="card-body mt-4">
            <!--pagetitle-->
            <div class="d-flex justify-content-between">
                <div class="pagetitle">                
                </div>
            </div>

            <section class="section leavedetails">
                {% if request.GET.msg %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ request.GET.msg }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                    {% endif %}
                    {% if request.GET.error %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ request.GET.error }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endif %}
               
                <!--Button Section-->
                <div class="btn-toolbar justify-content-between " role="toolbar" aria-label="Toolbar with button groups">
                    <!--Request Button-->
                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-outline-danger small-btn" data-bs-toggle="modal" data-bs-target="#exampleModal">
                        Request PTO
                    </button>
                    
                    <!-- Request Modal -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">Request Leave</h1>
                                    <button type="button" class="btn-close p-3" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{% url 'add_leave' %}">
                                    <div class="modal-body">
                                        {% csrf_token %}    
                                        <div class="row">

                                            <!-- Requested Date -->
                                            <div class="col-md-6 mb-3">
                                                <label for="daterequest" class="col-form-label">Requested Date:</label>
                                                <input type="datetime-local" class="form-control" id="daterequest" readonly name="req_date" >
                                            </div>

                                            <!-- Category -->
                                            <div class="col-md-6 mb-3">
                                                <label for="floatingSelect" class="col-form-label">Leave Type:</label>
                                                    <select name="type" id="floatingSelect" class="form-control">
                                                <option value="" disabled selected>Select Leave Type</option>
                                                {% for type in categories %}
                                                    <option value="{{ type.id }}">{{ type.name }}</option>
                                                {% empty %}
                                                    <option disabled>No leave types found</option>
                                                {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <!-- Leave From -->
                                            <div class="col-md-4 mb-3">
                                                <label for="leavefromdate" class="col-form-label">Leave From:</label>
                                                <input type="date" class="form-control" id="leavefromdate" name="leave_from">
                                            </div>
                                            <!-- Leave To -->
                                            <div class="col-md-4 mb-3">
                                                <label for="leavetodate" class="col-form-label">Leave To:</label>
                                                <input type="date" class="form-control" id="leavetodate" name="leave_to">
                                            </div>
                                            <!-- Count Of Days -->
                                            <div class="col-md-4 mb-3">
                                                <label class="col-form-label">You are requesting a PTO of:</label>
                                                <p id="countofdays" class="form-control-plaintext">0 days</p>
                                            </div>
                                        </div>

                                        <!-- Decription -->
                                        <div class="mb-3">
                                            <label for="description" class="col-form-label">Description:</label>
                                            <textarea class="form-control" rows="4" id="description" name="description"></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        {% comment %} <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button> {% endcomment %}
                                        <button type="submit" class="btn btn-success btn-sm">Send Request</button>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Approve Leave Details Modal -->
                    <div class="modal fade" id="approveLeaveModal" tabindex="-1" aria-labelledby="approveLeaveModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-md">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="approveLeaveModalLabel">Approve Leave Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="approve-leave-form">
                                        <input type="hidden" id="leaveId" name="leave_id">
                                        <!-- Approval Status -->
                                        <div class="mb-3 col-9">
                                            <label for="approvalStatus" class="form-label">Approval Status</label>
                                            <select class="form-control" id="approvalStatus" name="approval_id">
                                                <option selected disabled>Select status</option>
                                                {% for approval in approvals %}
                                                <option value="{{ approval.id }}">{{ approval.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- User Details -->
                                        <div class="mb-3">
                                            <label for="userRemarks" class="form-label">User Description</label>
                                            <textarea class="form-control" id="userRemarks" rows="3" readonly></textarea>
                                        </div>

                                        <!-- Remarks -->
                                        <div class="mb-3">
                                            <label for="adminRemarks" class="form-label">Remarks (optional)</label>
                                            <textarea class="form-control" id="adminRemarks" rows="3"></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" id="approve-confirm-btn" class="btn btn-success btn-sm">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="d-flex justify-content-end " style="gap: 10px;">
                        <!-- User Dropdown Only for Admin -->
                        <div class="btn-group" {% if not request.user.is_staff %}hidden{% endif %}>
                            <button type="button" id="user" class="btn btn-outline-danger dropdown-toggle small-btn" data-bs-toggle="dropdown" aria-expanded="false">

                                {% if selected_user %}
                                    {{ selected_user.first_name }}  
                                {% else %}
                                    Filter User
                                {% endif %}
                            </button>
                            
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="updateFilters('user_id', '')">Show All</a>
                                {% for user in users %}
                                    <a class="dropdown-item" href="#" onclick="updateFilters('user_id', '{{ user.id }}')">
                                        {{ user.first_name }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>

                        <!--Date Filter Button-->
                        <div class="btn-group" role="group">
                            <button type="button" id="date" class="btn btn-outline-danger dropdown-toggle small-btn" data-bs-toggle="dropdown" aria-expanded="false">

                                {% if selected_date %}
                                    {{ selected_date }}  
                                {% else %}
                                    Date
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu">

                                <li><a class="dropdown-item" href="#">
                                    <!-- <input type="date" id="date-picker" class="form-control border border-secondary"> -->
                                    <input type="date" id="date-picker" class="form-control border border-secondary" onchange="updateFilters('date', this.value)">

                                </a></li>
                            </ul>
                        </div>
                        
                        <!--Category -->
                        <div class="btn-group" role="group">
                            <button type="button" id="category" class="btn btn-outline-danger dropdown-toggle small-btn" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if selected_category %}
                                    {{ selected_category }}
                                {% else %}
                                    Category
                                {% endif %}
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="updateFilters('category', '')">Show All</a>
                                {% for category in categories %}
                                    <a class="dropdown-item" href="#" onclick="updateFilters('category', '{{ category.name }}')">
                                        {{ category.name }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>

                        <!--Status-->
                        <div class="btn-group" role="group">
                            <button type="button" id="status" class="btn btn-outline-danger dropdown-toggle small-btn" data-bs-toggle="dropdown" aria-expanded="false">

                                {% if selected_status %}
                                    {{ selected_status }}  
                                {% else %}
                                    Status
                                {% endif %}
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="updateFilters('status', '')">Show All</a>
                                {% for approval in approvals %}
                                <a class="dropdown-item" href="#" onclick="updateFilters('status', '{{ approval.name }}')">
                                    {{ approval.name }}
                                </a>
                                {% endfor %}

                            </div>
                        </div>
                    </div>
                </div>


                <!--table-->
                <table id="leavedetails-table" class="table table-hover table-product w-100 nowrap mt-4" style="width:100%">
                    <thead>
                        <tr class="column-head">
                            <th>Requested Date</th>
                            <th>Category</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Approval</th>
                            {% if request.user.is_staff%}
                                <th>User</th>
                            {%else%}
                                <th>Approved By</th>
                            {% endif %}
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for leave in leaves %}
                            <tr>
                                <td>{{ leave.requested_date }}</td>
                                <td>{{leave.type.name}}</td>
                                <td>{{leave.leave_from}}</td>
                                <td>{{leave.leave_to}}</td>
                                <td>{{leave.approval.name|default:"Pending"}}</td>
                                {% if request.user.is_staff %}
                                    <td>{{leave.user.first_name}}</td>
                                {% else %}
                                    <td>{{leave.approvedby.first_name|default:"Not approved yet"}}</td>
                                {% endif %}
                                <td class="text-center">
                                    <i class="fa-regular fa-pen-to-square text-primary hover-white"
                                        role="button"
                                        data-bs-toggle="modal"
                                        data-bs-target="#approveLeaveModal"
                                        data-leave-id="{{ leave.id }}"
                                        data-approval-id="{{ leave.approval.id }}"
                                        data-remarks="{{ leave.remarks|escapejs }}"
                                        data-description = "{{ leave.description|escapejs }}"
                                        title="Edit or Approve Leave">
                                    </i>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
        </div>
    </div>


        <!-- <div class="row d-flex p-5">
            {% for i in categories %}    
                <div class="col-xl-3 col-md-3">
                    <div class="card card-default">
                    <div class="d-flex p-5 align-items-center flex-column">
                        <div class="icon-md bg-secondary rounded-circle mb-2 ">
                            
                        {% for j in leavedays %}   
                            {% if i.id == j.type.id %}
                            <i class="col-md-3 text-center h2">{{ j.availableDays }}</i>
                            {% else %}
                            <i class="col-md-3 text-center h2">{{ i.days }}</i>

                            {% endif %}
                        
                        {% endfor %}
                        </div>
                        <div class="text-center ">
                        <p>{{ i.name }}</p>
                        </div>
                    </div>
                    </div>
                </div>
            {% endfor %}

            
        </div> -->

        <div class="row d-flex p-5">



                
                    
                <!-- First box -->
                <div class="col-xl-3 col-md-3">
                    <div class="card card-default">
                    <div class="d-flex p-5 align-items-center flex-column">
                        <div class="icon-md bg-secondary rounded-circle mb-2 ">
                        
                        {% for j in leavedays%}
                        {% if j.type.name == "Personal Leave" %}
                        <i class="col-md-3 text-center h2">{{ j.availableDays|default:10 }}</i>
                        {% endif %}
                        {% endfor %}
                        
                        </div>
                        <div class="text-center ">
                        <p>Personal Leave</p>
                        </div>
                    </div>
                    </div>
                </div>




                <!-- Second box -->
                <div class="col-xl-3 col-md-3">
                    <div class="card card-default">
                    <div class="d-flex p-5 align-items-center flex-column">
                        <div class="icon-md bg-success rounded-circle mb-2">

                        {% for j in leavedays%}
                        {% if j.type.name == "Sick Leave" %}
                        <i class="col-md-3 text-center h2">{{ j.availableDays }}</i>
                        {% endif %}
                        {% endfor %}

                        </div>
                        <div class="text-center">
                        <p>Sick Leave</p>
                        </div>
                    </div>
                    </div>
                </div>




                <!-- Third box -->
                <div class="col-xl-3 col-md-3">
                    <div class="card card-default">
                    <div class="d-flex p-5 align-items-center flex-column">
                        <div class="icon-md bg-primary rounded-circle mb-2">

                        {% for j in leavedays%}
                        {% if j.type.name == "Floating Holiday" %}
                        <i class="col-md-3 text-center h2">{{ j.availableDays }}</i>
                        {% endif %}
                        {% endfor %}

                        </div>
                        <div class="text-center">
                        <p>Floating Holiday</p>
                        </div>
                    </div>
                    </div>
                </div>




                <!-- Fourth box -->
                <div class="col-xl-3 col-md-3">
                    <div class="card card-default">
                    <div class="d-flex p-5 align-items-center flex-column">
                        <div class="icon-md bg-info rounded-circle mb-2">
                        {% for j in leavedays%}
                        {% if j.type.name == "Bereavement" %}
                        <i class="col-md-3 text-center h2">{{ j.availableDays|default:10 }}</i>
                        {% endif %}
                        {% endfor %}
                        </div>
                        <div class="text-center">
                        <p>Bereavement</p>
                        </div>
                    </div>
                    </div>
                </div>



            </div>
        </div>


</main><!-- End #main -->



<!--Date Requested-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let now = new Date();
        let year = now.getFullYear();
        let month = String(now.getMonth() + 1).padStart(2, '0');
        let day = String(now.getDate()).padStart(2, '0');
        let hours = String(now.getHours()).padStart(2, '0');
        let minutes = String(now.getMinutes()).padStart(2, '0');
    
        let formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById("daterequest").value = formattedDateTime;
    });
</script>

<script>
    function updateFilters(param, value) {
        let url = new URL(window.location.href);
        let params = new URLSearchParams(url.search);

        if (value) {
            params.set(param, value);
        } else {
            params.delete(param);
        }

        // Keep existing parameters
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }
</script>

<!--added for leavedetails table-->
{% comment %} <script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'assets/js/datatables.min.js' %}"></script>
<script src="{% static 'assets/js/pdfmake.min.js' %}"></script>
<script src="{% static 'assets/js/vfs_fonts.js' %}"></script>
<script src="{% static 'assets/js/custom.js' %}"></script> {% endcomment %}


<!--all scripts-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous">
</script>


<!-- for table -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!--propper js for dropdown-->
<!-- jQuery (slim version) and Bootstrap 4 Bundle (includes Popper) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>


<!-- Approval form -->
<script>
    document.getElementById('approve-confirm-btn').addEventListener('click', function () {
        const leaveId = document.getElementById('leaveId').value;
        const approvalStatus = document.getElementById('approvalStatus').value;
        const remarks = document.getElementById('adminRemarks').value;

        fetch("{% url 'approve_leave' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                leave_id: leaveId,
                approval_id: approvalStatus,
                remarks: remarks
            })
        }).then(response => {
            if (response.ok) {
                // Close modal and refresh page
                $('#approveLeaveModal').modal('hide');

                window.location.reload();
            } else {
                alert("Failed to approve leave.");
            }
        });
        console.log({
            leaveId,
            approvalStatus,
            remarks
        });

    });
</script>

<!-- Filling approval form -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // When the modal is shown
        const approveModal = document.getElementById('approveLeaveModal');
        approveModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;

            const leaveId = button.getAttribute('data-leave-id');
            const approvalId = button.getAttribute('data-approval-id');
            const remarks = button.getAttribute('data-remarks');
            const description = button.getAttribute('data-description')

            // Set values in modal inputs
            document.getElementById('leaveId').value = leaveId;
            document.getElementById('approvalStatus').value = approvalId;
            document.getElementById('adminRemarks').value = remarks || "";
            document.getElementById('userRemarks').value = description ;
        });
    });
</script>

<!--for date for request modal-->
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function () {
    let now = new Date();
    let year = now.getFullYear();
    let month = String(now.getMonth() + 1).padStart(2, '0');
    let day = String(now.getDate()).padStart(2, '0');

    let formattedDate = `${year}-${month}-${day}`;
    const leavefrom = document.getElementById("leavefromdate");
    const leaveto = document.getElementById("leavetodate");

    if (leavefrom) {
        leavefrom.value = formattedDate;
        leavefrom.min = formattedDate;
    }
    if (leaveto) {
        leaveto.value = formattedDate;
        leaveto.min = formattedDate;
    }
});
</script>

<!-- Count the days -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const fromInput = document.getElementById('leavefromdate');
    const toInput = document.getElementById('leavetodate');
    const countDisplay = document.getElementById('countofdays');

    function calculateWeekdays(startDate, endDate) {
        let count = 0;
        let currentDate = new Date(startDate);

        while (currentDate <= endDate) {
            const day = currentDate.getDay();
            if (day !== 0 && day !== 6) { // not Sunday (0) or Saturday (6)
                count++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return count;
    }

    function updateCount() {
        const fromDate = new Date(fromInput.value);
        const toDate = new Date(toInput.value);

        if (fromInput.value && toInput.value && fromDate <= toDate) {
            const weekdays = calculateWeekdays(fromDate, toDate);
            countDisplay.textContent = `${weekdays} days`;
        } else {
            countDisplay.textContent = "0 days";
        }
    }

    fromInput.addEventListener('change', updateCount);
    toInput.addEventListener('change', updateCount);
});
</script>


{% endblock %}
